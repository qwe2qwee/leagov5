// deno-lint-ignore-file no-explicit-any
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
// ========================================================================
// CORS + Environment
// ========================================================================
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type, x-requested-with, accept",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Max-Age": "86400",
};
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
const AUTHENTICA_API_KEY =
  "$2y$10$P7V123TDwDF5bGBqP3D3f.LXr8NyXfu5Vo6CAilmL66tHS9w6jPPq";
if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
  throw new Error("Missing environment variables");
}
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
console.log("âœ… Supabase initialized");
// ========================================================================
// Configuration
// ========================================================================
const CONFIG = {
  RATE_LIMIT_WINDOW: 15 * 60 * 1000,
  MAX_ATTEMPTS: 5,
  OTP_EXPIRY: 5 * 60 * 1000,
};
// ========================================================================
// Utilities
// ========================================================================
function normalizePhoneNumber(phone) {
  if (!phone || typeof phone !== "string" || phone.length > 20) {
    return {
      normalized: "",
      isValid: false,
      error: "Invalid phone format",
    };
  }
  let normalized = phone.replace(/[^\d+]/g, "");
  // Convert to +966 format
  if (normalized.startsWith("0")) normalized = "+966" + normalized.slice(1);
  else if (normalized.startsWith("5")) normalized = "+966" + normalized;
  else if (normalized.startsWith("966")) normalized = "+" + normalized;
  else if (!normalized.startsWith("+966")) {
    return {
      normalized: "",
      isValid: false,
      error: "Invalid Saudi phone",
    };
  }
  // Validate pattern: +966 5X XXXXXXX
  if (!/^\+9665[0-9]\d{7}$/.test(normalized)) {
    return {
      normalized: "",
      isValid: false,
      error: "Invalid Saudi mobile number",
    };
  }
  return {
    normalized,
    isValid: true,
  };
}
function generateSessionId() {
  const timestamp = Date.now();
  const random = Array.from(crypto.getRandomValues(new Uint8Array(16)), (b) =>
    b.toString(16).padStart(2, "0")
  ).join("");
  return `auth_${timestamp}_${random}`;
}
function createResponse(success, data, status = success ? 200 : 400) {
  return new Response(
    JSON.stringify({
      success,
      timestamp: new Date().toISOString(),
      ...data,
    }),
    {
      status,
      headers: {
        ...corsHeaders,
        "Content-Type": "application/json",
      },
    }
  );
}
function extractClientIP(req) {
  return (
    req.headers.get("x-forwarded-for")?.split(",")[0]?.trim() ||
    req.headers.get("x-real-ip") ||
    "unknown"
  );
}
// ========================================================================
// Main Handler
// ========================================================================
serve(async (req) => {
  // CORS preflight
  if (req.method === "OPTIONS") {
    return new Response(null, {
      headers: corsHeaders,
    });
  }
  if (req.method !== "POST") {
    return createResponse(
      false,
      {
        error: "Method not allowed",
      },
      405
    );
  }
  const clientIP = extractClientIP(req);
  try {
    // Parse request
    const body = await req.json().catch(() => null);
    if (!body?.phone) {
      return createResponse(false, {
        error: "Phone number is required",
      });
    }
    console.log(`ğŸ“± Processing: ...${body.phone.slice(-4)}`);
    // Validate phone
    const { normalized, isValid, error } = normalizePhoneNumber(body.phone);
    if (!isValid) {
      return createResponse(false, {
        error,
      });
    }
    // ========================================================================
    // âœ… Rate Limiting (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ check_rate_limit)
    // ========================================================================
    const { data: rateLimitCheck, error: rateLimitError } = await supabase.rpc(
      "check_rate_limit",
      {
        p_identifier: normalized,
        p_action_type: "otp_send",
        p_max_attempts: CONFIG.MAX_ATTEMPTS,
        p_window_minutes: Math.ceil(CONFIG.RATE_LIMIT_WINDOW / 60000),
      }
    );
    if (rateLimitError || !rateLimitCheck) {
      return createResponse(
        false,
        {
          error: `Too many requests. Wait 15 minutes.`,
          retry_after: Math.ceil(CONFIG.RATE_LIMIT_WINDOW / 1000),
        },
        429
      );
    }
    // Generate session
    const sessionId = generateSessionId();
    // ========================================================================
    // âœ… Call Authentica API (Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·)
    // ========================================================================
    console.log("ğŸ“¤ Calling Authentica...");
    const authenticaResponse = await fetch(
      "https://api.authentica.sa/api/v2/send-otp",
      {
        method: "POST",
        headers: {
          "X-Authorization": AUTHENTICA_API_KEY,
          Accept: "application/json",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          method: "sms",
          phone: normalized,
          template_id: 1,
        }),
      }
    ).catch(() => null);
    if (!authenticaResponse || !authenticaResponse.ok) {
      const errorData = await authenticaResponse?.json().catch(() => ({}));
      console.error("âŒ Authentica failed:", errorData);
      // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ´Ù„
      await supabase.rpc("log_security_event", {
        p_event_type: "otp_send_failed",
        p_user_id: null,
        p_identifier: normalized,
        p_details: {
          error: errorData.message || "Authentica API failed",
          timestamp: new Date().toISOString(),
          ip: clientIP,
        },
      });
      return createResponse(
        false,
        {
          error: errorData.message || "SMS service unavailable",
        },
        502
      );
    }
    const authenticaData = await authenticaResponse.json();
    console.log("âœ… OTP sent via Authentica");
    // ========================================================================
    // âœ… Store in Database (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ otp_requests)
    // ========================================================================
    const { error: otpInsertError } = await supabase
      .from("otp_requests")
      .insert({
        phone: normalized,
        authentica_session_id: sessionId,
        status: "pending",
        expires_at: new Date(Date.now() + CONFIG.OTP_EXPIRY).toISOString(),
        created_at: new Date().toISOString(),
      });
    if (otpInsertError) {
      console.error("âš ï¸ DB storage failed:", otpInsertError);
    } else {
      console.log("ğŸ’¾ Stored OTP request");
    }
    // ========================================================================
    // âœ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø£Ù…Ù†ÙŠ Ù†Ø§Ø¬Ø­
    // ========================================================================
    await supabase.rpc("log_security_event", {
      p_event_type: "otp_send_success",
      p_user_id: null,
      p_identifier: normalized,
      p_details: {
        method: "authentica",
        session_id: sessionId,
        expires_at: new Date(Date.now() + CONFIG.OTP_EXPIRY).toISOString(),
        ip: clientIP,
      },
    });
    // ========================================================================
    // âœ… Success Response
    // ========================================================================
    return createResponse(true, {
      message: authenticaData.message || "OTP sent successfully",
      session_id: sessionId,
      phone: normalized,
      expires_in: Math.ceil(CONFIG.OTP_EXPIRY / 1000),
      expires_at: new Date(Date.now() + CONFIG.OTP_EXPIRY).toISOString(),
    });
  } catch (error) {
    console.error("âŒ Error:", error);
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
    try {
      await supabase.rpc("log_security_event", {
        p_event_type: "otp_send_error",
        p_user_id: null,
        p_identifier: "system",
        p_details: {
          error: error.message,
          stack: error.stack,
          timestamp: new Date().toISOString(),
        },
      });
    } catch (logError) {
      console.error("âŒ Failed to log error:", logError);
    }
    return createResponse(
      false,
      {
        error: "Internal server error",
      },
      500
    );
  }
});
console.log("ğŸš€ send-otp Edge Function running...");
