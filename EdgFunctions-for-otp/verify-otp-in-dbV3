// deno-lint-ignore-file no-explicit-any
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
// ========================================================================
// Ø¥Ø¹Ø¯Ø§Ø¯ CORS
// ========================================================================
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, x-requested-with, accept",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Max-Age": "86400"
};
// ========================================================================
// Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
// ========================================================================
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
const AUTHENTICA_API_KEY = "$2y$10$P7V123TDwDF5bGBqP3D3f.LXr8NyXfu5Vo6CAilmL66tHS9w6jPPq";
const NODE_ENV = Deno.env.get("NODE_ENV") || "production";
// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY || !AUTHENTICA_API_KEY) {
  console.error("âŒ Missing environment variables");
  throw new Error("Missing environment variables");
}
// Ø¥Ù†Ø´Ø§Ø¡ Supabase Client
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
console.log("âœ… Supabase client initialized");
// ========================================================================
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
// ========================================================================
const CONFIG = {
  TEMP_PASSWORD_LENGTH: 16,
  REQUEST_TIMEOUT: 30000,
  TEMP_PASSWORD_EXPIRY_HOURS: 24,
  RATE_LIMIT_MAX_ATTEMPTS: 5,
  RATE_LIMIT_WINDOW_MINUTES: 15
};
// ========================================================================
// Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© Ù‚ÙˆÙŠØ©
// ========================================================================
function generateTempPassword(length = CONFIG.TEMP_PASSWORD_LENGTH) {
  const lowercase = "abcdefghijklmnopqrstuvwxyz";
  const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const numbers = "0123456789";
  const symbols = "!@#$%^&*()-_+=[]{}|;:,.<>?";
  const allChars = lowercase + uppercase + numbers + symbols;
  // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø±Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† ÙƒÙ„ Ù†ÙˆØ¹
  const mandatoryChars = [
    lowercase[Math.floor(Math.random() * lowercase.length)],
    uppercase[Math.floor(Math.random() * uppercase.length)],
    numbers[Math.floor(Math.random() * numbers.length)],
    symbols[Math.floor(Math.random() * symbols.length)]
  ];
  // Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø­Ø±Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
  const remaining = Array.from({
    length: length - 4
  }, ()=>allChars[Math.floor(Math.random() * allChars.length)]);
  // Ø®Ù„Ø· Ø§Ù„Ø£Ø­Ø±Ù
  return [
    ...mandatoryChars,
    ...remaining
  ].sort(()=>Math.random() - 0.5).join("");
}
// ========================================================================
// Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
// ========================================================================
function normalizePhoneNumber(phone) {
  if (!phone) {
    return {
      normalized: "",
      isValid: false,
      error: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙÙ‚ÙˆØ¯"
    };
  }
  // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø±Ù ØºÙŠØ± Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù…Ø§ Ø¹Ø¯Ø§ +
  let normalized = phone.replace(/[^\d+]/g, "");
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø¯ÙˆÙ„ÙŠØ©
  if (normalized.startsWith("0")) {
    normalized = "+966" + normalized.slice(1);
  }
  if (normalized.startsWith("5")) {
    normalized = "+966" + normalized;
  }
  if (normalized.startsWith("966")) {
    normalized = "+" + normalized;
  }
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  if (!/^\+9665\d{8}$/.test(normalized)) {
    return {
      normalized: "",
      isValid: false,
      error: "ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ØµÙŠØºØ©: +966XXXXXXXXX"
    };
  }
  return {
    normalized,
    isValid: true
  };
}
// ========================================================================
// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª
// ========================================================================
function createErrorResponse(error, status = 400) {
  return new Response(JSON.stringify({
    success: false,
    error,
    timestamp: new Date().toISOString()
  }), {
    status,
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json"
    }
  });
}
function createSuccessResponse(data) {
  return new Response(JSON.stringify({
    success: true,
    ...data,
    timestamp: new Date().toISOString()
  }), {
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json"
    }
  });
}
// ========================================================================
// Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ IP Ù…Ù† Ø§Ù„Ø·Ù„Ø¨
// ========================================================================
function extractClientIP(req) {
  return req.headers.get("x-forwarded-for")?.split(",")[0]?.trim() || req.headers.get("x-real-ip") || "unknown";
}
// ========================================================================
// Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// ========================================================================
serve(async (req)=>{
  // Ù…Ø¹Ø§Ù„Ø¬Ø© CORS Preflight
  if (req.method === "OPTIONS") {
    return new Response(null, {
      headers: corsHeaders
    });
  }
  // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ù€ POST
  if (req.method !== "POST") {
    return createErrorResponse("ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø·Ù„Ø¨Ø§Øª POST", 405);
  }
  try {
    // ========================================================================
    // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø·Ù„Ø¨
    // ========================================================================
    const body = await req.json();
    const { phone, otp_code } = body;
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if (!phone || !otp_code) {
      return createErrorResponse("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù…Ø² OTP Ù…ÙÙ‚ÙˆØ¯");
    }
    // ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
    const { normalized, isValid, error } = normalizePhoneNumber(phone);
    if (!isValid) {
      return createErrorResponse(error);
    }
    console.log(`ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: ${normalized}`);
    // ========================================================================
    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Rate Limiting
    // ========================================================================
    const { data: rateLimitCheck, error: rateLimitError } = await supabase.rpc("check_rate_limit", {
      p_identifier: normalized,
      p_action_type: "otp_verification",
      p_max_attempts: CONFIG.RATE_LIMIT_MAX_ATTEMPTS,
      p_window_minutes: CONFIG.RATE_LIMIT_WINDOW_MINUTES
    });
    if (rateLimitError || !rateLimitCheck) {
      console.error("âŒ ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª:", rateLimitError);
      return createErrorResponse("ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹", 429);
    }
    console.log("âœ… Rate limit check passed");
    // ========================================================================
    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP Ø¹Ø¨Ø± Authentica
    // ========================================================================
    const authResp = await fetch("https://api.authentica.sa/api/v2/verify-otp", {
      method: "POST",
      headers: {
        "X-Authorization": AUTHENTICA_API_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        phone: normalized,
        otp: otp_code
      })
    });
    const authData = await authResp.json();
    if (!authData.status) {
      console.log("âŒ OTP verification failed");
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙØ§Ø´Ù„Ø©
      await supabase.rpc("log_security_event", {
        p_event_type: "otp_verification_failed",
        p_user_id: null,
        p_identifier: normalized,
        p_details: {
          reason: "invalid_otp",
          timestamp: new Date().toISOString(),
          ip: extractClientIP(req)
        }
      });
      return createErrorResponse("Ø±Ù…Ø² OTP ØºÙŠØ± ØµØ­ÙŠØ­");
    }
    console.log("âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP Ø¨Ù†Ø¬Ø§Ø­");
    // ========================================================================
    // 4. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† profiles
    // ========================================================================
    const { data: existingUser, error: profileError } = await supabase.from("profiles").select("user_id, email, full_name").eq("phone", normalized).single();
    if (profileError || !existingUser?.user_id) {
      console.error("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:", profileError);
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«
      await supabase.rpc("log_security_event", {
        p_event_type: "otp_user_not_found",
        p_user_id: null,
        p_identifier: normalized,
        p_details: {
          error: profileError?.message,
          timestamp: new Date().toISOString()
        }
      });
      return createErrorResponse("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    }
    const userId = existingUser.user_id;
    console.log(`ğŸ‘¤ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`);
    // ========================================================================
    // 5. Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©
    // ========================================================================
    const tempPassword = generateTempPassword();
    const tempPasswordExpiresAt = new Date(Date.now() + CONFIG.TEMP_PASSWORD_EXPIRY_HOURS * 60 * 60 * 1000);
    console.log("ğŸ”‘ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©");
    // ========================================================================
    // 6. ØªØ­Ø¯ÙŠØ« auth.users (ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± + metadata)
    // ========================================================================
    const { error: updateUserError } = await supabase.auth.admin.updateUserById(userId, {
      password: tempPassword,
      user_metadata: {
        phone: normalized,
        phone_verified: true,
        phone_verified_at: new Date().toISOString(),
        temp_password_set_at: new Date().toISOString(),
        temp_password_expires_at: tempPasswordExpiresAt.toISOString()
      }
    });
    if (updateUserError) {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", updateUserError);
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
      await supabase.rpc("log_security_event", {
        p_event_type: "temp_password_creation_failed",
        p_user_id: userId,
        p_identifier: normalized,
        p_details: {
          error: updateUserError.message,
          timestamp: new Date().toISOString()
        }
      });
      return createErrorResponse("ÙØ´Ù„ ÙÙŠ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©");
    }
    console.log("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ù†Ø¬Ø§Ø­");
    // ========================================================================
    // 7. ØªØ­Ø¯ÙŠØ« profiles (is_verified + phone_verified_at)
    // ========================================================================
    const { error: updateProfileError } = await supabase.from("profiles").update({
      is_verified: true,
      phone_verified_at: new Date().toISOString()
    }).eq("user_id", userId);
    if (updateProfileError) {
      console.error("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ:", updateProfileError);
    // Ù„Ø§ Ù†Ø±Ø¬Ø¹ Ø®Ø·Ø£ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ ÙØ¹Ù„ÙŠØ§Ù‹
    } else {
      console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ");
    }
    // ========================================================================
    // 8. ØªØ­Ø¯ÙŠØ« otp_requests (ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ verified)
    // ========================================================================
    const { error: otpUpdateError } = await supabase.from("otp_requests").update({
      status: "verified",
      verified_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }).eq("phone", normalized).eq("status", "pending").order("created_at", {
      ascending: false
    }).limit(1);
    if (otpUpdateError) {
      console.error("âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« otp_requests:", otpUpdateError);
    // Ù„Ø§ Ù†Ø±Ø¬Ø¹ Ø®Ø·Ø£ Ù„Ø£Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù†Ø¬Ø­Øª
    } else {
      console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« otp_requests");
    }
    // ========================================================================
    // 9. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ auth_logs
    // ========================================================================
    const clientIP = extractClientIP(req);
    const userAgent = req.headers.get("user-agent") || "unknown";
    await supabase.rpc("log_auth_attempt", {
      p_user_id: userId,
      p_action: "otp_verification_success",
      p_ip_address: clientIP,
      p_user_agent: userAgent
    });
    console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ auth_logs");
    // ========================================================================
    // 10. ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø£Ù…Ù†ÙŠ Ù†Ø§Ø¬Ø­
    // ========================================================================
    await supabase.rpc("log_security_event", {
      p_event_type: "otp_verification_success",
      p_user_id: userId,
      p_identifier: normalized,
      p_details: {
        method: "authentica",
        temp_password_created: true,
        temp_password_expires_at: tempPasswordExpiresAt.toISOString(),
        ip: clientIP,
        user_agent: userAgent
      }
    });
    console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø£Ù…Ù†ÙŠ");
    // ========================================================================
    // 11. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    // ========================================================================
    return createSuccessResponse({
      message: "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP ÙˆØ¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© Ø¨Ù†Ø¬Ø§Ø­",
      temp_password: tempPassword,
      temp_password_expires_at: tempPasswordExpiresAt.toISOString(),
      temp_password_expires_in_hours: CONFIG.TEMP_PASSWORD_EXPIRY_HOURS,
      user: {
        id: userId,
        phone: normalized,
        email: existingUser.email,
        full_name: existingUser.full_name
      },
      note: `ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© ØµØ§Ù„Ø­Ø© Ù„Ù…Ø¯Ø© ${CONFIG.TEMP_PASSWORD_EXPIRY_HOURS} Ø³Ø§Ø¹Ø© ÙÙ‚Ø·. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØºÙŠÙŠØ±Ù‡Ø§ ÙÙˆØ±Ø§Ù‹.`
    });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", err);
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
    try {
      await supabase.rpc("log_security_event", {
        p_event_type: "otp_verification_error",
        p_user_id: null,
        p_identifier: "system",
        p_details: {
          error: err.message,
          stack: err.stack,
          timestamp: new Date().toISOString()
        }
      });
    } catch (logError) {
      console.error("âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:", logError);
    }
    return createErrorResponse("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…", 500);
  }
});
console.log("ğŸš€ Edge Function: verify-otp is running...");
