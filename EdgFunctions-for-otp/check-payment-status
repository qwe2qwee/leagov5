// supabase/functions/check-payment-status/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
// ==========================================
// CORS HEADERS
// ==========================================
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
};
// ==========================================
// ENVIRONMENT VARIABLES
// ==========================================
const MOYASAR_SECRET_KEY = Deno.env.get("MOYASAR_SECRET_KEY");
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
// ==========================================
// MAIN HANDLER
// ==========================================
serve(async (req) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response(null, {
      headers: corsHeaders,
    });
  }
  try {
    console.log("ğŸ” Starting payment status check...");
    // ==========================================
    // 1. AUTHENTICATION
    // ==========================================
    const authHeader = req.headers.get("Authorization");
    if (!authHeader) {
      throw new Error("Missing authorization header");
    }
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
    const jwt = authHeader.replace("Bearer ", "");
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser(jwt);
    if (authError || !user) {
      console.error("Authentication failed:", authError);
      throw new Error("Unauthorized");
    }
    console.log("âœ… User authenticated:", user.id);
    // ==========================================
    // 2. PARSE REQUEST BODY
    // ==========================================
    const { paymentId, bookingId } = await req.json();
    if (!paymentId || !bookingId) {
      throw new Error("Missing required fields: paymentId and bookingId");
    }
    console.log("ğŸ“‹ Checking payment:", {
      paymentId,
      bookingId,
    });
    // ==========================================
    // 3. FETCH BOOKING DATA
    // ==========================================
    const { data: booking, error: bookingError } = await supabase
      .from("bookings")
      .select(
        `
        *,
        car:cars(
          id,
          model:car_models(
            name_ar, 
            name_en, 
            brand:car_brands(name_ar, name_en)
          )
        ),
        branch:branches(id, name_ar, name_en, manager_id)
      `
      )
      .eq("id", bookingId)
      .eq("customer_id", user.id)
      .single();
    if (bookingError || !booking) {
      console.error("Booking not found:", bookingError);
      throw new Error("Booking not found or unauthorized");
    }
    console.log("âœ… Booking found:", booking.id, "Status:", booking.status);
    // ==========================================
    // 4. FETCH PAYMENT STATUS FROM MOYASAR
    // ==========================================
    const auth = btoa(`${"sk_test_G398iwnZxwTkvwvdz1krcjv1VU56r4RSdzB7pYRj"}:`);
    const moyasarResponse = await fetch(
      `https://api.moyasar.com/v1/payments/${paymentId}`,
      {
        headers: {
          Authorization: `Basic ${auth}`,
        },
      }
    );
    if (!moyasarResponse.ok) {
      console.error("Moyasar API error:", moyasarResponse.status);
      throw new Error("Failed to fetch payment status from Moyasar");
    }
    const payment = await moyasarResponse.json();
    console.log("ğŸ’³ Moyasar payment status:", payment.status);
    // ==========================================
    // 5. HANDLE PAYMENT STATUS (Ù…Ø­Ø¯Ø«)
    // ==========================================
    // âœ… CASE 1: Payment successful
    if (payment.status === "paid") {
      console.log("âœ… Payment is paid");
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ø² Ø¨Ø¹Ø¯ØŒ Ø­Ø¯Ø«Ù‡
      if (booking.status !== "active") {
        console.log("ğŸ”„ Completing booking payment...");
        await completeBookingPayment(
          supabase,
          bookingId,
          paymentId,
          booking,
          user.id
        );
        console.log("âœ… Booking payment completed successfully");
      } else {
        console.log("â„¹ï¸ Booking already active");
      }
      return new Response(
        JSON.stringify({
          success: true,
          status: "paid",
          paymentId: paymentId,
          bookingStatus: "active",
          message: "Payment completed successfully",
        }),
        {
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json",
          },
          status: 200,
        }
      );
    }
    // âŒ CASE 2: Payment failed (Ù…Ø­Ø¯Ø«)
    if (payment.status === "failed") {
      console.log("âŒ Payment failed");
      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ confirmed Ù…Ø¹ 24 Ø³Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
      if (booking.status === "payment_pending") {
        const newExpiresAt = new Date();
        newExpiresAt.setHours(newExpiresAt.getHours() + 24);
        const { error: revertError } = await supabase
          .from("bookings")
          .update({
            status: "confirmed",
            expires_at: newExpiresAt.toISOString(),
            updated_at: new Date().toISOString(),
          })
          .eq("id", bookingId);
        if (revertError) {
          console.error("Failed to revert booking status:", revertError);
        } else {
          console.log("âœ… Booking reverted to confirmed with new 24h deadline");
        }
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø¬Ø¯ÙŠØ¯)
        try {
          await supabase.rpc("send_notification", {
            _to_user: user.id,
            _title_ar: "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹",
            _title_en: "âŒ Payment Verification Failed",
            _message_ar: `ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹: ${
              payment.source?.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
            }. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©`,
            _message_en: `Payment verification failed: ${
              payment.source?.message || "Unknown error"
            }. You can retry within 24 hours`,
            _type: "warning",
            _metadata: {
              booking_id: bookingId,
              payment_id: paymentId,
              error: payment.source?.message,
            },
            _sent_via: "system",
          });
          console.log("âœ… Failure notification sent to customer");
        } catch (notifError) {
          console.warn("âš ï¸ Failed to send notification:", notifError);
        }
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø£Ù…Ù†ÙŠ (Ø¬Ø¯ÙŠØ¯)
        try {
          await supabase.rpc("log_security_event", {
            _event_type: "payment_failed",
            _user_id: user.id,
            _identifier: bookingId,
            _details: {
              booking_id: bookingId,
              payment_id: paymentId,
              error: payment.source?.message,
              timestamp: new Date().toISOString(),
            },
          });
          console.log("âœ… Security event logged");
        } catch (logError) {
          console.warn("âš ï¸ Failed to log security event:", logError);
        }
      }
      return new Response(
        JSON.stringify({
          success: false,
          status: "failed",
          message: payment.source?.message || "Payment failed",
          bookingStatus: "confirmed",
        }),
        {
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json",
          },
          status: 200,
        }
      );
    }
    // â³ CASE 3: Payment still being processed
    if (payment.status === "initiated") {
      console.log("â³ Payment still being processed");
      return new Response(
        JSON.stringify({
          success: true,
          status: "initiated",
          message: "Payment is still being processed",
          transactionUrl: payment.source?.transaction_url,
        }),
        {
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json",
          },
          status: 200,
        }
      );
    }
    // ğŸ”„ CASE 4: Payment authorized (waiting for capture) (Ø¬Ø¯ÙŠØ¯)
    if (payment.status === "authorized") {
      console.log("ğŸ”„ Payment authorized, waiting for capture");
      return new Response(
        JSON.stringify({
          success: true,
          status: "authorized",
          message: "Payment authorized, waiting for final confirmation",
        }),
        {
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json",
          },
          status: 200,
        }
      );
    }
    // ğŸ’° CASE 5: Payment refunded (Ø¬Ø¯ÙŠØ¯)
    if (payment.status === "refunded") {
      console.log("ğŸ’° Payment was refunded");
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø¬Ø² Ù†Ø´Ø·Ø§Ù‹ØŒ Ø£Ù„ØºÙŠÙ‡
      if (booking.status === "active") {
        await supabase
          .from("bookings")
          .update({
            status: "cancelled",
            notes: "ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº",
            updated_at: new Date().toISOString(),
          })
          .eq("id", bookingId);
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„
        try {
          await supabase.rpc("send_notification", {
            _to_user: user.id,
            _title_ar: "ğŸ’° ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº",
            _title_en: "ğŸ’° Payment Refunded",
            _message_ar: "ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¨Ù„Øº Ø§Ù„Ø­Ø¬Ø². ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹",
            _message_en:
              "Payment has been refunded. Booking automatically cancelled",
            _type: "info",
            _metadata: {
              booking_id: bookingId,
              payment_id: paymentId,
            },
            _sent_via: "system",
          });
        } catch (notifError) {
          console.warn("âš ï¸ Failed to send notification:", notifError);
        }
      }
      return new Response(
        JSON.stringify({
          success: true,
          status: "refunded",
          message: "Payment was refunded",
          bookingStatus: "cancelled",
        }),
        {
          headers: {
            ...corsHeaders,
            "Content-Type": "application/json",
          },
          status: 200,
        }
      );
    }
    // âš ï¸ CASE 6: Unknown or other status
    console.log("â„¹ï¸ Payment status:", payment.status);
    return new Response(
      JSON.stringify({
        success: true,
        status: payment.status,
        message: `Payment status: ${payment.status}`,
        bookingStatus: booking.status,
      }),
      {
        headers: {
          ...corsHeaders,
          "Content-Type": "application/json",
        },
        status: 200,
      }
    );
  } catch (error) {
    console.error("âŒ Error in check-payment-status:", error);
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message || "Internal server error",
      }),
      {
        headers: {
          ...corsHeaders,
          "Content-Type": "application/json",
        },
        status: 400,
      }
    );
  }
});
// ==========================================
// COMPLETE BOOKING PAYMENT
// ==========================================
async function completeBookingPayment(
  supabase,
  bookingId,
  paymentReference,
  booking,
  userId
) {
  try {
    console.log("ğŸ“ Step 1: Updating booking status...");
    // 1. Update booking to active
    const { error: updateError } = await supabase
      .from("bookings")
      .update({
        status: "active",
        payment_reference: paymentReference,
        expires_at: null,
        updated_at: new Date().toISOString(),
      })
      .eq("id", bookingId);
    if (updateError) {
      console.error("âŒ Error updating booking:", updateError);
      throw updateError;
    }
    console.log("âœ… Booking status updated to active");
    // 2. Send customer notification
    console.log("ğŸ“¢ Step 2: Sending customer notification...");
    try {
      await supabase.rpc("send_notification", {
        _to_user: userId,
        _title_ar: "âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²",
        _title_en: "âœ… Booking Confirmed",
        _message_ar: `ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­. Ø­Ø¬Ø²Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø´Ø·. Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹: ${paymentReference}`,
        _message_en: `Payment successful. Your booking is now active. Reference: ${paymentReference}`,
        _type: "booking_update",
        _metadata: {
          booking_id: bookingId,
          payment_reference: paymentReference,
        },
        _sent_via: "system",
      });
      console.log("âœ… Customer notification sent");
    } catch (notifError) {
      console.error(
        "âš ï¸ Customer notification failed (non-critical):",
        notifError
      );
    }
    // 3. Send branch manager notification
    if (booking.branch?.manager_id) {
      console.log("ğŸ“¢ Step 3: Sending branch manager notification...");
      try {
        await supabase.rpc("send_notification", {
          _to_user: booking.branch.manager_id,
          _title_ar: "ğŸ‰ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ Ù†Ø´Ø·",
          _title_en: "ğŸ‰ New Active Booking",
          _message_ar: `ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯. Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹: ${paymentReference}`,
          _message_en: `New booking payment confirmed. Reference: ${paymentReference}`,
          _type: "booking_update",
          _metadata: {
            booking_id: bookingId,
            payment_reference: paymentReference,
          },
          _sent_via: "system",
        });
        console.log("âœ… Manager notification sent");
      } catch (notifError) {
        console.error(
          "âš ï¸ Manager notification failed (non-critical):",
          notifError
        );
      }
    }
    // 4. Log security event
    console.log("ğŸ“ Step 4: Logging security event...");
    try {
      await supabase.rpc("log_security_event", {
        _event_type: "payment_completed",
        _user_id: userId,
        _identifier: bookingId,
        _details: {
          booking_id: bookingId,
          payment_reference: paymentReference,
          amount: booking.final_amount,
          timestamp: new Date().toISOString(),
        },
      });
      console.log("âœ… Security event logged");
    } catch (auditError) {
      console.error("âš ï¸ Audit log failed (non-critical):", auditError);
    }
    console.log("âœ… Complete booking payment finished successfully");
    return true;
  } catch (error) {
    console.error("âŒ Error completing booking payment:", error);
    throw error;
  }
}
