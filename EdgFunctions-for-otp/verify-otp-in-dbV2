// deno-lint-ignore-file no-explicit-any
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
// Ø¥Ø¹Ø¯Ø§Ø¯ CORS
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type, x-requested-with, accept",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Max-Age": "86400"
};
// Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
const AUTHENTICA_API_KEY = "$2y$10$P7V123TDwDF5bGBqP3D3f.LXr8NyXfu5Vo6CAilmL66tHS9w6jPPq";
const NODE_ENV = Deno.env.get("NODE_ENV") || "production";
if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY || !AUTHENTICA_API_KEY) {
  console.error("âŒ Missing environment variables");
  throw new Error("Missing environment variables");
}
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
console.log("âœ… Supabase client initialized");
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
const CONFIG = {
  TEMP_PASSWORD_LENGTH: 16,
  REQUEST_TIMEOUT: 30000
};
function generateTempPassword(length = CONFIG.TEMP_PASSWORD_LENGTH) {
  const lowercase = "abcdefghijklmnopqrstuvwxyz";
  const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const numbers = "0123456789";
  const symbols = "!@#$%^&*()-_+=[]{}|;:,.<>?";
  const allChars = lowercase + uppercase + numbers + symbols;
  const mandatoryChars = [
    lowercase[Math.floor(Math.random() * lowercase.length)],
    uppercase[Math.floor(Math.random() * uppercase.length)],
    numbers[Math.floor(Math.random() * numbers.length)],
    symbols[Math.floor(Math.random() * symbols.length)]
  ];
  const remaining = Array.from({
    length: length - 4
  }, ()=>allChars[Math.floor(Math.random() * allChars.length)]);
  return [
    ...mandatoryChars,
    ...remaining
  ].sort(()=>Math.random() - 0.5).join("");
}
function normalizePhoneNumber(phone) {
  if (!phone) return {
    normalized: "",
    isValid: false,
    error: "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ÙÙ‚ÙˆØ¯"
  };
  let normalized = phone.replace(/[^\d+]/g, "");
  if (normalized.startsWith("0")) normalized = "+966" + normalized.slice(1);
  if (normalized.startsWith("5")) normalized = "+966" + normalized;
  if (normalized.startsWith("966")) normalized = "+" + normalized;
  if (!/^\+9665\d{8}$/.test(normalized)) return {
    normalized: "",
    isValid: false,
    error: "ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"
  };
  return {
    normalized,
    isValid: true
  };
}
function createErrorResponse(error, status = 400) {
  return new Response(JSON.stringify({
    success: false,
    error,
    timestamp: new Date().toISOString()
  }), {
    status,
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json"
    }
  });
}
function createSuccessResponse(data) {
  return new Response(JSON.stringify({
    success: true,
    ...data
  }), {
    headers: {
      ...corsHeaders,
      "Content-Type": "application/json"
    }
  });
}
serve(async (req)=>{
  if (req.method === "OPTIONS") return new Response(null, {
    headers: corsHeaders
  });
  if (req.method !== "POST") return createErrorResponse("ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ø·Ù„Ø¨Ø§Øª POST", 405);
  try {
    const body = await req.json();
    const { phone, otp_code } = body;
    if (!phone || !otp_code) return createErrorResponse("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù…Ø² OTP Ù…ÙÙ‚ÙˆØ¯");
    const { normalized, isValid, error } = normalizePhoneNumber(phone);
    if (!isValid) return createErrorResponse(error);
    console.log(`ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: ${normalized}`);
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP Ø¹Ø¨Ø± Authentica
    const authResp = await fetch("https://api.authentica.sa/api/v2/verify-otp", {
      method: "POST",
      headers: {
        "X-Authorization": AUTHENTICA_API_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        phone: normalized,
        otp: otp_code
      })
    });
    const authData = await authResp.json();
    if (!authData.status) {
      return createErrorResponse("Ø±Ù…Ø² OTP ØºÙŠØ± ØµØ­ÙŠØ­");
    }
    console.log("âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP Ø¨Ù†Ø¬Ø§Ø­");
    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† profiles
    const { data: existingUser, error: profileError } = await supabase.from("profiles").select("user_id, email").eq("phone", normalized).single();
    if (profileError || !existingUser?.user_id) return createErrorResponse("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    const userId = existingUser.user_id;
    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©
    const tempPassword = generateTempPassword();
    console.log("ğŸ”‘ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©");
    // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø²Ø§Ù„Ø© phone Ùˆ phone_confirm
    const { error: updateUserError } = await supabase.auth.admin.updateUserById(userId, {
      password: tempPassword,
      user_metadata: {
        phone: normalized,
        phone_verified: true,
        temp_password_set_at: new Date().toISOString()
      }
    });
    if (updateUserError) {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", updateUserError);
      return createErrorResponse("ÙØ´Ù„ ÙÙŠ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©");
    }
    console.log("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ù†Ø¬Ø§Ø­");
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ profiles
    await supabase.from("profiles").update({
      is_verified: true,
      phone_verified_at: new Date().toISOString()
    }).eq("user_id", userId);
    return createSuccessResponse({
      message: "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† OTP ÙˆØ¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©",
      temp_password: tempPassword,
      user: {
        id: userId,
        phone: normalized,
        email: existingUser.email
      }
    });
  } catch (err) {
    console.error("âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", err);
    return createErrorResponse("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…", 500);
  }
});
